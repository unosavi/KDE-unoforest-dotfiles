# ~/.zshrc - 효율적이고 현대적인 zsh 설정

# ============================================================================
# 성능 최적화 설정
# ============================================================================
# 빠른 시작을 위한 지연 로딩 활성화
autoload -Uz compinit
# 하루에 한 번만 보안 검사 (속도 향상)
if [[ -n ${ZDOTDIR:-$HOME}/.zcompdump(#qN.mh+24) ]]; then
    compinit
else
    compinit -C
fi

# ============================================================================
# zsh 옵션 설정 (현대적 기본값)
# ============================================================================
# 디렉토리 탐색
setopt AUTO_CD                  # 디렉토리 이름만 입력해도 이동
setopt AUTO_PUSHD              # cd 시 자동으로 pushd
setopt PUSHD_IGNORE_DUPS       # 중복된 디렉토리는 pushd 스택에서 제거
setopt PUSHD_SILENT            # pushd/popd 메시지 숨김

# 글로빙과 확장
setopt EXTENDED_GLOB           # 확장된 glob 패턴 사용
setopt GLOB_DOTS              # 숨김 파일도 glob 매칭에 포함
setopt NOMATCH                # 매치되지 않는 패턴에 대해 오류 출력

# 작업 제어
setopt NOTIFY                 # 백그라운드 작업 완료시 즉시 알림
setopt LONG_LIST_JOBS         # 작업 목록을 자세히 표시

# 프롬프트
setopt PROMPT_SUBST           # 프롬프트에서 변수 치환 허용

# 주석 무시
setopt interactive_comments

# ============================================================================
# 히스토리 설정 (향상된 설정)
# ============================================================================
HISTFILE=~/.zsh_history
HISTSIZE=50000                # 메모리 내 히스토리 크기 증가
SAVEHIST=50000               # 파일에 저장되는 히스토리 크기 증가

setopt EXTENDED_HISTORY       # 타임스탬프와 함께 히스토리 저장
setopt APPEND_HISTORY         # 히스토리 파일에 추가
setopt SHARE_HISTORY          # 세션간 히스토리 실시간 공유
setopt HIST_IGNORE_DUPS       # 연속된 중복 명령어 무시
setopt HIST_IGNORE_ALL_DUPS   # 모든 중복 명령어 제거
setopt HIST_IGNORE_SPACE      # 공백으로 시작하는 명령어 히스토리에서 제외
setopt HIST_FIND_NO_DUPS      # 히스토리 검색시 중복 제외
setopt HIST_REDUCE_BLANKS     # 불필요한 공백 제거
setopt HIST_VERIFY            # 히스토리 확장 결과를 실행 전에 보여줌

# ============================================================================
# 완성 시스템 설정 (성능 최적화)
# ============================================================================
# 완성 경로 설정
if [[ -d /usr/share/zsh/site-functions ]]; then
    fpath=(/usr/share/zsh/site-functions $fpath)
fi

# 완성 스타일 (현대적 설정)
zstyle ':completion:*' menu select                           # 메뉴 선택 활성화
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}'    # 대소문자 구분 안함
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"      # LS_COLORS 사용
zstyle ':completion:*' completer _complete _approximate       # 근사 매칭 추가
zstyle ':completion:*' use-cache on                          # 완성 캐시 사용
zstyle ':completion:*' cache-path ~/.zsh/cache              # 캐시 경로 설정
zstyle ':completion:*' group-name ''                        # 그룹별 완성 표시
zstyle ':completion:*:descriptions' format '%B%d%b'         # 그룹 설명 포맷
zstyle ':completion:*:warnings' format 'No matches for: %d' # 매치 없을 때 메시지

# 프로세스 완성 개선
zstyle ':completion:*:processes' command 'ps -au$USER -o pid,time,cmd|grep -v "ps -au$USER -o pid,time,cmd"'

# ============================================================================
# 플러그인 로드 (효율적 로딩)
# ============================================================================
# zsh-syntax-highlighting (바닐라 설정 유지)
if [[ -f /usr/share/zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh ]]; then
    source /usr/share/zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
fi

# zsh-autosuggestions (개선된 설정)
if [[ -f /usr/share/zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh ]]; then
    source /usr/share/zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh
    ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE="fg=#566b65"
    ZSH_AUTOSUGGEST_STRATEGY=(history completion)              # 히스토리와 완성 둘 다 사용
    ZSH_AUTOSUGGEST_BUFFER_MAX_SIZE=20                        # 성능을 위한 버퍼 크기 제한
fi

# ============================================================================
# 환경 변수 (최적화)
# ============================================================================
export EDITOR=nano
export BROWSER=firefox
export TERM=xterm-256color
export LANG=ko_KR.UTF-8                    # 한국어 로케일 설정
export LC_ALL=ko_KR.UTF-8

# 색상 지원 개선
if [[ -x /usr/bin/dircolors ]]; then
    eval "$(dircolors -b)"
fi

# ============================================================================
# 별칭 설정 (효율성 개선)
# ============================================================================
# 사용자 정의 별칭
alias unocr='cd /home/unoverse/Main/dev/ocr_normal && ./run_ocr.sh'
alias unoblur='cd /home/unoverse/Main/dev/scripts && ./a.sh'
alias unogrub='cd /home/unoverse/Main/dev/scripts && sudo ./grub-update-korean.sh'

# Podman 컨테이너 제어 (기존 유지)
alias podstatus='podman ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"'

# ============================================================================
# Starship 프롬프트 (지연 없는 초기화)
# ============================================================================
eval "$(starship init zsh)"

# ============================================================================
# 터미널 최적화 (Konsole/Ghostty 호환)
# ============================================================================
# 캐시 디렉토리 생성
[[ ! -d ~/.zsh ]] && mkdir -p ~/.zsh/cache

# 터미널 제목 설정 (성능 최적화)
case $TERM in
    konsole*|xterm*|*256color*|ghostty)
        # 더 효율적인 터미널 제목 설정
        autoload -Uz add-zsh-hook

        function xterm_title_precmd () {
            print -Pn '\e]2;%n@%m:%~\a'
        }

        function xterm_title_preexec () {
            print -Pn '\e]2;%n@%m:%~ - ${1%% *}\a'
        }

        add-zsh-hook -Uz precmd xterm_title_precmd
        add-zsh-hook -Uz preexec xterm_title_preexec
        ;;
esac

# ============================================================================
# 성능 모니터링 (개발용 - 필요시 주석 해제)
# ============================================================================
# zsh 시작 시간 측정하려면 맨 위에 zmodload zsh/zprof 추가하고
# 맨 아래에 zprof 추가

# Podman 개별 컨테이너 제어 (스마트 시작)
alias pod1on="(systemctl --user is-active podman.service >/dev/null || systemctl --user start podman.service) && podman start qwen2api"
alias pod2on="(systemctl --user is-active podman.service >/dev/null || systemctl --user start podman.service) && podman start openrouter-proxy-main_app_1"
alias pod1off="podman stop qwen2api"
alias pod2off="podman stop openrouter-proxy-main_app_1"
